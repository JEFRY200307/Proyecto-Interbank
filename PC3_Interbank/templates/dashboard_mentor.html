{% extends 'dashboard_base.html' %}
{% load static %}

{% block content %}
<h2>Empresas a tu cargo</h2>
<div class="empresas-tarjetas-container">
  <!-- Las tarjetas de empresas se cargarán por JS -->
</div>

<div id="detalle-empresa-panel" style="display:none; margin-top:2rem;">
  <h2>Detalle de la empresa</h2>
  <form id="form-editar-empresa" class="form-detalle-empresa"></form>
  <div class="detalle-empresa-botones">
    <button type="button" onclick="cerrarDetalleEmpresa()">Volver a empresas</button>
  </div>
</div>

<!-- Panel de estrategias (puedes dejarlo si lo usas) -->
<div id="estrategias-panel" style="display:none; margin-top:2rem;">
  <h2 id="titulo-empresa"></h2>
  <button onclick="cerrarPanelEstrategias()" style="margin-bottom:1rem;">Volver a empresas</button>
  <div class="estrategias-list">
    <table class="estrategias-table" style="width:100%; border: 1px solid black;">
      <thead>
        <tr>
          <th>Título</th>
          <th>Descripción</th>
          <th>Categoría</th>
          <th>Estado</th>
          <th>Fecha de Registro</th>
          <th>Fecha de Cumplimiento</th>
          <th>Actividades</th>
        </tr>
      </thead>
      <tbody id="estrategias-tbody">
        <!-- Estrategias se insertan aquí por JS -->
      </tbody>
    </table>
  </div>
</div>

<style>
.empresas-tarjetas-container {
  display: flex;
  flex-wrap: wrap;
  gap: 1.5rem;
  margin-top: 2rem;
}
.tarjeta-empresa {
  background: #f7f7f7;
  border: 1px solid #b2dfdb;
  border-radius: 10px;
  box-shadow: 0 2px 8px #e0f2f1;
  padding: 1.2rem 1.5rem;
  width: 260px;
  cursor: pointer;
  transition: box-shadow 0.2s;
}
.tarjeta-empresa:hover {
  box-shadow: 0 4px 16px #80cbc4;
  background: #e0f7fa;
}
.estrategias-table th, .estrategias-table td {
  padding: 0.7rem;
  border: 1px solid #b2dfdb;
}
.estrategias-table th {
  background: #e0f2f1;
}
.actividad-editable {
  width: 90%;
  padding: 0.3rem;
  border: 1px solid #b2dfdb;
  border-radius: 5px;
}
.btn-guardar {
  background: #388e3c;
  color: #fff;
  border: none;
  padding: 0.4rem 1rem;
  border-radius: 5px;
  cursor: pointer;
  margin-top: 0.5rem;
}
.btn-guardar:hover {
  background: #43a047;
}
.form-detalle-empresa {
  max-width: 500px;
  margin: 0 auto;
  background: #f7f7f7;
  border: 1px solid #b2dfdb;
  border-radius: 10px;
  padding: 2rem 2.5rem;
  box-shadow: 0 2px 8px #e0f2f1;
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.form-detalle-empresa label {
  font-weight: 500;
  margin-bottom: 0.2rem;
  display: flex;
  flex-direction: column;
  color: #00695c;
}

.form-detalle-empresa input {
  padding: 0.5rem;
  border: 1px solid #b2dfdb;
  border-radius: 5px;
  margin-top: 0.2rem;
  font-size: 1rem;
}

.form-detalle-empresa input:focus {
  outline: 2px solid #26a69a;
}

.form-detalle-empresa button[type="submit"] {
  background: #388e3c;
  color: #fff;
  border: none;
  padding: 0.7rem 1.5rem;
  border-radius: 5px;
  cursor: pointer;
  margin-top: 1rem;
  font-size: 1rem;
  align-self: flex-end;
}

.form-detalle-empresa button[type="submit"]:hover {
  background: #43a047;
}

.detalle-empresa-botones {
  text-align: center;
  margin-top: 1.5rem;
}

.detalle-empresa-botones button {
  background: #00838f;
  color: #fff;
  border: none;
  padding: 0.6rem 1.2rem;
  border-radius: 5px;
  cursor: pointer;
  font-size: 1rem;
}

.detalle-empresa-botones button:hover {
  background: #0097a7;
}
</style>

<script>
let empresaSeleccionadaId = null;
let estrategiasActuales = [];

// Cargar empresas del mentor por AJAX
document.addEventListener('DOMContentLoaded', async function() {
    const token = localStorage.getItem('access_token');
    const container = document.querySelector('.empresas-tarjetas-container');
    if (!token) {
        container.innerHTML = '<p>No autenticado.</p>';
        return;
    }
    const res = await fetch('/mentor/api/empresas/', {
        headers: { 'Authorization': 'Bearer ' + token }
    });
    if (res.ok) {
        const empresas = await res.json();
        if (empresas.length === 0) {
            container.innerHTML = '<p>No tienes empresas asignadas.</p>';
        } else {
            container.innerHTML = empresas.map(e => `
                <div class="tarjeta-empresa"
                     data-id="${e.id}"
                     onclick="mostrarDetalleEmpresa(${e.id})">
                  <h3>${e.razon_social}</h3>
                  <p><strong>RUC:</strong> ${e.ruc}</p>
                  <p><strong>Correo:</strong> ${e.correo}</p>
                  <p><strong>Estado:</strong> ${e.estado}</p>
                </div>
            `).join('');
        }
    } else {
        container.innerHTML = '<p>Error al cargar empresas.</p>';
    }
});

// Mostrar detalle editable de la empresa
async function mostrarDetalleEmpresa(empresaId) {
    empresaSeleccionadaId = empresaId;
    document.querySelector('.empresas-tarjetas-container').style.display = 'none';
    document.getElementById('detalle-empresa-panel').style.display = 'block';

    const token = localStorage.getItem('access_token');
    const res = await fetch(`/mentor/api/empresas/${empresaId}/`, {
        headers: { 'Authorization': 'Bearer ' + token }
    });
    if (res.ok) {
        const empresa = await res.json();
        let formHtml = `
            <label>Razón Social: <input name="razon_social" value="${empresa.razon_social || ''}"></label><br>
            <label>RUC: <input name="ruc" value="${empresa.ruc || ''}"></label><br>
            <label>Representante: <input name="representante" value="${empresa.representante || ''}"></label><br>
            <label>Correo: <input name="correo" value="${empresa.correo || ''}"></label><br>
            <label>Dirección: <input name="direccion" value="${empresa.direccion || ''}"></label><br>
            <label>Teléfono: <input name="telefono" value="${empresa.telefono || ''}"></label><br>
            <label>Departamento: <input name="departamento" value="${empresa.departamento || ''}"></label><br>
            <label>Provincia: <input name="provincia" value="${empresa.provincia || ''}"></label><br>
            <label>Distrito: <input name="distrito" value="${empresa.distrito || ''}"></label><br>
            <label>Estado: <input name="estado" value="${empresa.estado || ''}"></label><br>
            <label>Objetivo: <input name="objetivo" value="${empresa.objetivo || ''}"></label><br>
            <label>Misión: <input name="mision" value="${empresa.mision || ''}"></label><br>
            <label>Visión: <input name="vision" value="${empresa.vision || ''}"></label><br>
            <label>Valores: <input name="valores" value="${empresa.valores || ''}"></label><br>
            <label>Historia: <input name="historia" value="${empresa.historia || ''}"></label><br>
            <label>Web: <input name="web" value="${empresa.web || ''}"></label><br>
            <label>Facebook: <input name="facebook" value="${empresa.facebook || ''}"></label><br>
            <label>Instagram: <input name="instagram" value="${empresa.instagram || ''}"></label><br>
            <button type="submit">Guardar cambios</button>
        `;
        const form = document.getElementById('form-editar-empresa');
        form.innerHTML = formHtml;

        form.onsubmit = async function(e) {
            e.preventDefault();
            const formData = new FormData(form);
            const data = {};
            formData.forEach((v, k) => data[k] = v);
            const putRes = await fetch(`/mentor/api/empresas/${empresaId}/`, {
                method: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            if (putRes.ok) {
                alert('Datos actualizados correctamente');
                cerrarDetalleEmpresa();
            } else {
                alert('Error al actualizar');
            }
        };
    } else {
        alert('No se pudo cargar la empresa');
        cerrarDetalleEmpresa();
    }
}

function cerrarDetalleEmpresa() {
    document.getElementById('detalle-empresa-panel').style.display = 'none';
    document.querySelector('.empresas-tarjetas-container').style.display = 'flex';
    empresaSeleccionadaId = null;
}

// --- El resto de tu JS para estrategias puede quedarse igual ---
</script>

<a href="{% url 'mentor_solicitudes' %}" class="btn-flotante-solicitudes" title="Empresas que solicitan mentoría">
  Ver empresas que solicitan mentoría
</a>
<style>
.btn-flotante-solicitudes {
  position: fixed;
  right: 2.5rem;
  bottom: 2.5rem;
  background: #43a047;
  color: #fff;
  padding: 1rem 1.7rem;
  border-radius: 50px;
  box-shadow: 0 4px 16px #388e3c55;
  font-size: 1.1rem;
  font-weight: bold;
  text-decoration: none;
  z-index: 1000;
  transition: background 0.2s, box-shadow 0.2s;
}
.btn-flotante-solicitudes:hover {
  background: #388e3c;
  box-shadow: 0 6px 24px #388e3c88;
}
</style>
{% endblock %}