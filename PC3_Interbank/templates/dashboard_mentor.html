{% extends 'dashboard_base.html' %}
{% load static %}

{% block page_title %}
    Gestión de Empresas
{% endblock %}

{% block header_actions %}
    <button id="verSolicitudesBtn" class="btn btn-primary">Ver Solicitudes</button>
{% endblock %}

{% block content %}
    <!-- Contenedor para las tarjetas de las empresas asignadas -->
    <div id="empresas-tarjetas-container" class="empresas-tarjetas-container">
        <!-- Las tarjetas se cargarán aquí con JS -->
    </div>

    <!-- Panel oculto para el detalle de la empresa (se mostrará al hacer clic) -->
    <div id="detalle-empresa-panel" style="display: none;">
        <button onclick="cerrarDetalleEmpresa()" class="btn-volver">← Volver a Empresas</button>
        <h3 id="detalle-empresa-nombre"></h3>
        <p id="detalle-empresa-ruc"></p>
        <button onclick="mostrarEstrategiasEmpresa()" class="btn btn-primary">Ver/Editar Estrategias</button>
    </div>

    <!-- Panel oculto para las estrategias de la empresa -->
    <div id="panel-estrategias-empresa" style="display: none;">
        <button onclick="cerrarPanelEstrategiasEmpresa()" class="btn-volver">← Volver al Detalle</button>
        <h3>Estrategias de <span id="nombre-empresa-estrategias"></span></h3>
        <div id="tabla-estrategias-container"></div>
    </div>

    <!-- Modal para mostrar las solicitudes de mentoría -->
    <div id="solicitudesModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Empresas que solicitan mentoría</h2>
            <div id="solicitudes-container">
                <!-- El contenido de las solicitudes se cargará aquí desde tu API -->
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <!-- Vinculamos el script que contiene toda la lógica que ya tenías -->
    <script src="{% static 'js/mentor_dashboard.js' %}"></script>
{% endblock %}

<style>
  .empresas-tarjetas-container {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    margin-top: 2rem;
  }
  .tarjeta-empresa {
    background: #f7f7f7;
    border: 1px solid #b2dfdb;
    border-radius: 10px;
    box-shadow: 0 2px 8px #e0f2f1;
    padding: 1.2rem 1.5rem;
    width: 260px;
    cursor: pointer;
    transition: box-shadow 0.2s;
  }
  .tarjeta-empresa:hover {
    box-shadow: 0 4px 16px #80cbc4;
    background: #e0f7fa;
  }
  .tabla-scroll {
    width: 100%;
    overflow-x: auto;
  }
  .estrategias-table {
    display: table !important;
    width: 100%;
    table-layout: fixed;
    border-collapse: collapse;
    margin-bottom: 2rem;
  }
  .estrategias-table th, .estrategias-table td {
    border: 1px solid #b2dfdb;
    padding: 0.7rem;
    vertical-align: top;
    text-align: left;
  }
  .estrategias-table th {
    background: #e0f2f1;
    font-weight: bold;
    text-align: center;
  }
  .estrategias-table input, .estrategias-table textarea {
    width: 100%;
    box-sizing: border-box;
    padding: 0.3rem;
    border: 1px solid #b2dfdb;
    border-radius: 5px;
    font-size: 1rem;
    background: #fff;
    display: block;
  }
  .estrategias-table textarea {
    min-height: 2.5rem;
    resize: vertical;
  }
  .btn-guardar {
    background: #388e3c;
    color: #fff;
    border: none;
    padding: 0.4rem 1rem;
    border-radius: 5px;
    cursor: pointer;
    margin-top: 0.2rem;
  }
  .btn-guardar:hover {
    background: #43a047;
  }
  .modal-actividades {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0; top: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.4);
    justify-content: center;
    align-items: center;
  }
  .modal-actividades-content {
    background: #fff;
    margin: 5% auto;
    padding: 2rem;
    border-radius: 10px;
    width: 90%;
    max-width: 600px;
    box-shadow: 0 4px 24px #388e3c55;
    position: relative;
  }
  .close-modal {
    position: absolute;
    right: 1.2rem;
    top: 1.2rem;
    font-size: 2rem;
    color: #388e3c;
    cursor: pointer;
  }
  .etapa-row {
    border-bottom: 1px solid #b2dfdb;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
  }
  .actividad-row {
    display: flex;
    gap: 0.7rem;
    align-items: center;
    margin-bottom: 1rem;
  }
  .actividad-row input {
    border: 1px solid #b2dfdb;
    border-radius: 5px;
    padding: 0.3rem;
    font-size: 1rem;
    width: 100%;
  }

  /* Estilos para solicitudes de mentoría de estrategias - Diseño Interbank */
  .tarjeta-solicitud-interbank {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border: 1px solid #e9ecef;
    border-radius: 16px;
    padding: 0;
    margin-bottom: 2rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    position: relative;
  }

  .tarjeta-solicitud-interbank::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #00953b 0%, #02bb59 100%);
  }

  .tarjeta-solicitud-interbank:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 30px rgba(0, 149, 59, 0.15);
    border-color: #00953b;
  }

  .empresa-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 1.5rem 2rem;
    border-bottom: 1px solid #dee2e6;
  }

  .empresa-nombre {
    color: #00953b;
    font-size: 1.4rem;
    font-weight: 700;
    margin: 0 0 0.5rem 0;
    letter-spacing: -0.5px;
  }

  .empresa-ruc {
    background: #e9ecef;
    color: #495057;
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    display: inline-block;
  }

  .empresa-contacto {
    padding: 1.5rem 2rem;
    background: #ffffff;
    display: flex;
    gap: 2rem;
    border-bottom: 1px solid #f1f3f5;
  }

  .contacto-item {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    color: #495057;
    font-size: 0.95rem;
  }

  .contacto-item i {
    font-size: 1.1rem;
    color: #00953b;
    min-width: 20px;
    text-align: center;
  }

  .estrategia-info {
    padding: 1.5rem 2rem;
    background: #ffffff;
  }

  .estrategia-titulo {
    color: #2d3748;
    font-size: 1.2rem;
    font-weight: 600;
    margin: 0 0 1rem 0;
    line-height: 1.4;
  }

  .estrategia-descripcion {
    color: #6c757d;
    line-height: 1.6;
    margin: 0 0 1.5rem 0;
    font-size: 0.95rem;
  }

  .estrategia-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .categoria-badge {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    padding: 0.4rem 1rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .fecha-solicitud {
    color: #6c757d;
    font-size: 0.85rem;
    font-weight: 500;
  }

  .btn-aceptar-interbank {
    width: 100%;
    background: linear-gradient(135deg, #00953b 0%, #02bb59 100%);
    color: white;
    border: none;
    padding: 1rem 2rem;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .btn-aceptar-interbank:hover {
    background: linear-gradient(135deg, #007a2f 0%, #00953b 100%);
    transform: translateY(-2px);
  }

  .btn-aceptar-interbank:active {
    transform: translateY(0);
  }

  .btn-aceptar-interbank i {
    font-size: 1.2rem;
    font-weight: bold;
  }

  /* Responsive para dispositivos móviles */
  @media (max-width: 768px) {
    .tarjeta-solicitud-interbank {
      margin-bottom: 1.5rem;
    }
    
    .empresa-header, .empresa-contacto, .estrategia-info {
      padding: 1rem 1.5rem;
    }
    
    .empresa-contacto {
      flex-direction: column;
      gap: 1rem;
    }
    
    .estrategia-meta {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .btn-aceptar-interbank {
      padding: 0.8rem 1.5rem;
      font-size: 1rem;
    }
  }

  /* Estilos para las tarjetas de solicitudes del modal principal (compatibilidad) */
  .tarjeta-solicitud {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    transition: all 0.3s ease;
  }

  .tarjeta-solicitud:hover {
    border-color: #00953b;
    box-shadow: 0 4px 12px rgba(0, 149, 59, 0.1);
    transform: translateY(-2px);
  }

  .tarjeta-solicitud h3 {
    color: #00953b;
    margin-bottom: 1rem;
    font-size: 1.3rem;
    font-weight: 600;
  }

  .tarjeta-solicitud p {
    margin-bottom: 0.5rem;
    color: #495057;
    line-height: 1.4;
  }

  .tarjeta-solicitud strong {
    color: #343a40;
  }

  .tarjeta-solicitud .btn {
    margin-top: 1rem;
    padding: 0.6rem 1.5rem;
    font-weight: 600;
  }
</style>

<script>
let empresaSeleccionadaId = null;
let estrategiasEditadas = {};
let actividadesEditadas = {};
let estrategiaActualId = null;
let etapaActualId = null;

// Cargar empresas del mentor por AJAX
document.addEventListener('DOMContentLoaded', async function () {
  const token = localStorage.getItem('access_token');
  const container = document.querySelector('.empresas-tarjetas-container');
  if (!token) {
    container.innerHTML = '<p>No autenticado.</p>';
    return;
  }
  const res = await fetch('/mentor/api/empresas/', {
    headers: { 'Authorization': 'Bearer ' + token }
  });
  if (res.ok) {
    const empresas = await res.json();
    if (empresas.length === 0) {
      container.innerHTML = '<p>No tienes empresas asignadas.</p>';
    } else {
      container.innerHTML = empresas.map(e => `
        <div class="tarjeta-empresa"
             data-id="${e.id}"
             onclick="mostrarDetalleEmpresa(${e.id})">
          <h3>${e.razon_social}</h3>
          <p><strong>RUC:</strong> ${e.ruc}</p>
          <p><strong>Correo:</strong> ${e.correo}</p>
          <p><strong>Estado:</strong> ${e.estado}</p>
        </div>
      `).join('');
    }
  } else {
    container.innerHTML = '<p>Error al cargar empresas.</p>';
  }
});

// Mostrar detalle editable de la empresa
async function mostrarDetalleEmpresa(empresaId) {
  empresaSeleccionadaId = empresaId;
  document.querySelector('.empresas-tarjetas-container').style.display = 'none';
  document.getElementById('detalle-empresa-panel').style.display = 'block';

  const token = localStorage.getItem('access_token');
  const res = await fetch(`/mentor/api/empresas/${empresaId}/`, {
    headers: { 'Authorization': 'Bearer ' + token }
  });
  if (res.ok) {
    const empresa = await res.json();
    let formHtml = `
      <label>Razón Social: <input name="razon_social" value="${empresa.razon_social || ''}" readonly style="background:#eee;"></label><br>
      <label>RUC: <input name="ruc" value="${empresa.ruc || ''}" readonly style="background:#eee;"></label><br>
      <label>Representante: <input name="representante" value="${empresa.representante || ''}"></label><br>
      <label>Correo: <input name="correo" value="${empresa.correo || ''}"></label><br>
      <label>Dirección: <input name="direccion" value="${empresa.direccion || ''}"></label><br>
      <label>Teléfono: <input name="telefono" value="${empresa.telefono || ''}"></label><br>
      <label>Departamento: <input name="departamento" value="${empresa.departamento || ''}"></label><br>
      <label>Provincia: <input name="provincia" value="${empresa.provincia || ''}"></label><br>
      <label>Distrito: <input name="distrito" value="${empresa.distrito || ''}"></label><br>
      <label>Estado: <input name="estado" value="${empresa.estado || ''}"></label><br>
      <label>Objetivo: <input name="objetivo" value="${empresa.objetivo || ''}"></label><br>
      <label>Misión: <input name="mision" value="${empresa.mision || ''}"></label><br>
      <label>Visión: <input name="vision" value="${empresa.vision || ''}"></label><br>
      <label>Valores: <input name="valores" value="${empresa.valores || ''}"></label><br>
      <label>Historia: <input name="historia" value="${empresa.historia || ''}"></label><br>
      <label>Web: <input name="web" value="${empresa.web || ''}"></label><br>
      <label>Facebook: <input name="facebook" value="${empresa.facebook || ''}"></label><br>
      <label>Instagram: <input name="instagram" value="${empresa.instagram || ''}"></label><br>
      <button type="submit">Guardar cambios</button>
    `;
    const form = document.getElementById('form-editar-empresa');
    form.innerHTML = formHtml;

    form.onsubmit = async function (e) {
      e.preventDefault();
      const formData = new FormData(form);
      const data = {};
      formData.forEach((v, k) => data[k] = v);
      const putRes = await fetch(`/mentor/api/empresas/${empresaId}/`, {
        method: 'PUT',
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      });
      if (putRes.ok) {
        alert('Datos actualizados correctamente');
        cerrarDetalleEmpresa();
      } else {
        alert('Error al actualizar');
      }
    };
  } else {
    alert('No se pudo cargar la empresa');
    cerrarDetalleEmpresa();
  }
}

function cerrarDetalleEmpresa() {
  document.getElementById('detalle-empresa-panel').style.display = 'none';
  document.querySelector('.empresas-tarjetas-container').style.display = 'flex';
  empresaSeleccionadaId = null;
}

// Mostrar estrategias de la empresa
function mostrarEstrategiasEmpresa() {
  document.getElementById('detalle-empresa-panel').style.display = 'none';
  document.getElementById('panel-estrategias-empresa').style.display = 'block';
  cargarEstrategiasEmpresa(empresaSeleccionadaId);
}

function cerrarPanelEstrategiasEmpresa() {
  document.getElementById('panel-estrategias-empresa').style.display = 'none';
  document.getElementById('detalle-empresa-panel').style.display = 'block';
}

// Cargar estrategias y mostrar tabla
async function cargarEstrategiasEmpresa(empresaId) {
  const token = localStorage.getItem('access_token');
  const res = await fetch(`/empresas/api/estrategias/?empresa_id=${empresaId}`, {
    headers: { 'Authorization': 'Bearer ' + token }
  });
  const estrategias = await res.json();
  let html = '';
  if (estrategias.length === 0) {
    html = `<tr><td colspan="6" style="text-align:center;">No hay estrategias registradas.</td></tr>`;
  } else {
    html = estrategias.map(e => `
      <tr>
        <td><input value="${e.titulo || ''}" onchange="editarCampoEstrategia(${e.id}, 'titulo', this.value)" class="input-estrategia"></td>
        <td><textarea onchange="editarCampoEstrategia(${e.id}, 'descripcion', this.value)" class="input-estrategia">${e.descripcion || ''}</textarea></td>
        <td><input value="${e.categoria || ''}" onchange="editarCampoEstrategia(${e.id}, 'categoria', this.value)" class="input-estrategia"></td>
        <td><input value="${e.estado || ''}" onchange="editarCampoEstrategia(${e.id}, 'estado', this.value)" class="input-estrategia"></td>
        <td>${e.fecha_cumplimiento ? e.fecha_cumplimiento.slice(0, 10) : ''}</td>
        <td>
          <button onclick="guardarEstrategia(${e.id})" class="btn-guardar" type="button">Guardar</button>
          <button onclick="abrirModalEtapas(${e.id})" class="btn-guardar" type="button">Ver Etapas</button>
        </td>
      </tr>
    `).join('');
  }
  document.getElementById('estrategias-empresa-lista').innerHTML = html;
}

function editarCampoEstrategia(id, campo, valor) {
  if (!estrategiasEditadas[id]) estrategiasEditadas[id] = {};
  estrategiasEditadas[id][campo] = valor;
}

async function guardarEstrategia(id) {
  const token = localStorage.getItem('access_token');
  const resGet = await fetch(`/empresas/api/estrategias/${id}/`, {
    headers: { 'Authorization': 'Bearer ' + token }
  });
  if (!resGet.ok) {
    alert('No se pudo obtener la estrategia para actualizar.');
    return;
  }
  const estrategiaCompleta = await resGet.json();
  const cambios = estrategiasEditadas[id] || {};
  // Solo los campos válidos para PUT según tu serializer:
  const data = {
    titulo: cambios.titulo ?? estrategiaCompleta.titulo,
    descripcion: cambios.descripcion ?? estrategiaCompleta.descripcion,
    categoria: cambios.categoria ?? estrategiaCompleta.categoria,
    fecha_cumplimiento: cambios.fecha_cumplimiento ?? estrategiaCompleta.fecha_cumplimiento,
    estado: cambios.estado ?? estrategiaCompleta.estado
  };
  const res = await fetch(`/empresas/api/estrategias/${id}/`, {
    method: 'PUT',
    headers: {
      'Authorization': 'Bearer ' + token,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  });
  if (res.ok) {
    alert('Estrategia actualizada');
    cargarEstrategiasEmpresa(empresaSeleccionadaId);
    estrategiasEditadas[id] = {};
  } else {
    const text = await res.text();
    try {
      const errorData = JSON.parse(text);
      alert('Error al actualizar estrategia: ' + JSON.stringify(errorData));
    } catch {
      alert('Error inesperado: ' + text);
    }
  }
}

// --------- ETAPAS ---------
async function cargarEtapasEstrategia(estrategiaId) {
  const token = localStorage.getItem('access_token');
  const res = await fetch(`/empresas/api/estrategias/${estrategiaId}/etapas/`, {
    headers: { 'Authorization': 'Bearer ' + token }
  });
  const etapas = await res.json();
  let html = '';
  if (etapas.length === 0) {
    html = `<div>No hay etapas.</div>`;
  } else {
    html = etapas.map(etapa => `
      <div class="etapa-row">
        <input type="text" value="${etapa.nombre || ''}" onchange="editarCampoEtapa(${etapa.id}, 'nombre', this.value)">
        <textarea onchange="editarCampoEtapa(${etapa.id}, 'descripcion', this.value)">${etapa.descripcion || ''}</textarea>
        <button onclick="guardarEtapa(${etapa.id})" class="btn-guardar" type="button">Guardar</button>
        <button onclick="abrirModalActividades(${etapa.id})" class="btn-guardar" type="button">Ver Actividades</button>
      </div>
    `).join('');
  }
  document.getElementById('etapas-lista').innerHTML = html;
}

let etapasEditadas = {};

function editarCampoEtapa(id, campo, valor) {
  if (!etapasEditadas[id]) etapasEditadas[id] = {};
  etapasEditadas[id][campo] = valor;
}

async function guardarEtapa(id) {
  const token = localStorage.getItem('access_token');
  const resGet = await fetch(`/empresas/api/etapas/${id}/`, {
    headers: { 'Authorization': 'Bearer ' + token }
  });
  if (!resGet.ok) {
    alert('No se pudo obtener la etapa para actualizar.');
    return;
  }
  const etapaCompleta = await resGet.json();
  const cambios = etapasEditadas[id] || {};
  const data = {
    nombre: cambios.nombre ?? etapaCompleta.nombre,
    descripcion: cambios.descripcion ?? etapaCompleta.descripcion
  };
  // OBTENER EL ID DE LA ESTRATEGIA DE FORMA SEGURA:
  const estrategiaId = typeof etapaCompleta.estrategia === 'object'
    ? etapaCompleta.estrategia.id
    : etapaCompleta.estrategia;
  const res = await fetch(`/empresas/api/etapas/${id}/`, {
    method: 'PUT',
    headers: {
      'Authorization': 'Bearer ' + token,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  });
  if (res.ok) {
    alert('Etapa actualizada');
    etapasEditadas[id] = {};
  } else {
    const text = await res.text();
    try {
      const errorData = JSON.parse(text);
      alert('Error al actualizar etapa: ' + JSON.stringify(errorData));
    } catch {
      alert('Error inesperado: ' + text);
    }
  }
}
// --------- ACTIVIDADES ---------
async function cargarActividadesEtapa(etapaId) {
  const token = localStorage.getItem('access_token');
  const res = await fetch(`/empresas/api/etapas/${etapaId}/actividades/`, {
    headers: { 'Authorization': 'Bearer ' + token }
  });
  const actividades = await res.json();
  let html = '';
  if (actividades.length === 0) {
    html = `<div>No hay actividades.</div>`;
  } else {
    html = actividades.map(act => `
      <div class="actividad-row">
        <input type="text" value="${act.descripcion || ''}" onchange="editarCampoActividad(${act.id}, 'descripcion', this.value)">
        <input type="checkbox" ${act.completada ? 'checked' : ''} onchange="editarCampoActividad(${act.id}, 'completada', this.checked)">
        <button onclick="guardarActividad(${act.id})" class="btn-guardar" type="button">Guardar</button>
      </div>
    `).join('');
  }
  document.getElementById('actividades-lista').innerHTML = html;
}

function editarCampoActividad(id, campo, valor) {
  if (!actividadesEditadas[id]) actividadesEditadas[id] = {};
  actividadesEditadas[id][campo] = valor;
}

async function guardarActividad(id) {
  const token = localStorage.getItem('access_token');
  const resGet = await fetch(`/empresas/api/actividades/${id}/`, {
    headers: { 'Authorization': 'Bearer ' + token }
  });
  if (!resGet.ok) {
    alert('No se pudo obtener la actividad para actualizar.');
    return;
  }
  const actividadCompleta = await resGet.json();
  const cambios = actividadesEditadas[id] || {};
  const data = {
    descripcion: cambios.descripcion ?? actividadCompleta.descripcion,
    completada: cambios.completada ?? actividadCompleta.completada
  };
  // OBTENER EL ID DE LA ETAPA DE FORMA SEGURA:
  const etapaId = typeof actividadCompleta.etapa === 'object'
    ? actividadCompleta.etapa.id
    : actividadCompleta.etapa;
  const res = await fetch(`/empresas/api/actividades/${id}/`, {
    method: 'PUT',
    headers: {
      'Authorization': 'Bearer ' + token,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  });
  if (res.ok) {
    alert('Actividad actualizada');
    actividadesEditadas[id] = {};
  } else {
    const text = await res.text();
    try {
      const errorData = JSON.parse(text);
      alert('Error al actualizar actividad: ' + JSON.stringify(errorData));
    } catch {
      alert('Error inesperado: ' + text);
    }
  }
}

function abrirModalEtapas(estrategiaId) {
  estrategiaActualId = estrategiaId;
  document.getElementById('modal-etapas').style.display = 'flex';
  cargarEtapasEstrategia(estrategiaId);
}

function cerrarModalEtapas() {
  document.getElementById('modal-etapas').style.display = 'none';
  document.getElementById('etapas-lista').innerHTML = '';
}
function abrirModalActividades(etapaId) {
  etapaActualId = etapaId;
  document.getElementById('modal-actividades').style.display = 'flex';
  cargarActividadesEtapa(etapaId);
}

function cerrarModalActividades() {
  document.getElementById('modal-actividades').style.display = 'none';
  document.getElementById('actividades-lista').innerHTML = '';
}
</script>