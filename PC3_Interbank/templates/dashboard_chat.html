<!-- templates/dashboard_documentos.html -->
{% extends "dashboard_base.html" %}

{% block content %}
<div class="chat-container">
  <h2>Seleccione un Chatbot</h2>
  <div class="chat-buttons">
    {% for category in categories %}
      <button class="chat-select-btn" onclick="seleccionarCategoria({{ category.id }}, '{{ category.name|escapejs }}')">
        {{ category.name }}
      </button>
    {% endfor %}
  </div>

  <div id="chat-section" style="display:none; margin-top: 20px;">
    <h3 id="chat-category-title"></h3>
    <div id="chat-log" style="border:1px solid #ccc; min-height:300px; padding:1rem; margin-bottom:1rem; overflow-y:scroll;"></div>
    <div class="chat-input-area">
      <input type="text" id="user-message" placeholder="Escribe tu mensaje..." style="width:80%;">
      <button onclick="enviarMensaje()">Enviar</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script>
    let categoriaSeleccionada = null;
    let categoriaNombre = "";

    function seleccionarCategoria(id, nombre) {
      categoriaSeleccionada = id;
      categoriaNombre = nombre;
      document.getElementById('chat-section').style.display = 'block';
      document.getElementById('chat-category-title').textContent = "Chatbot: " + nombre;
      document.getElementById('chat-log').innerHTML = "";
    }

    function enviarMensaje() {
      const mensaje = document.getElementById('user-message').value;
      if (!mensaje || !categoriaSeleccionada) return;
      const token = localStorage.getItem('access_token');
      const log = document.getElementById('chat-log');
      
      // Mostrar mensaje del usuario
      log.innerHTML += `<div><strong>TÃº:</strong> ${mensaje}</div>`;
      document.getElementById('user-message').value = '';

      // Actualiza la URL al endpoint correcto:
      fetch(`/users/dashboard/chat/api/chatbot/${categoriaSeleccionada}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ message: mensaje })
      })
      .then(response => response.json())
      .then(data => {
        // Maneja la respuesta JSON
      })
      .catch(error => console.error("Error en el chatbot:", error));
    }
  </script>
{% endblock %}